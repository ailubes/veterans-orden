import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getAuthenticatedUserWithProfile } from '@/lib/auth/get-user';

export const dynamic = 'force-dynamic';

// Page data to reseed (correct MDX content)
const pagesToReseed = [
  {
    slug: 'about',
    title: 'ПРО ОРДЕН',
    label: 'ХТО МИ',
    description: 'Громадська структура підтримки, дисципліни та дії для ветеранів та їхніх союзників.',
    content: `ГО «Орден Ветеранів» створена як відповідь на реальність, у якій багато ветеранів стикаються не лише з фізичними наслідками війни, а й із соціальною порожнечею після повернення. Суспільство часто не дає зрозумілих "рельсів": як знайти підтримку, як об'єднатись, як не втратити себе, як не розчинитися в побуті та бюрократії.

## Ми будуємо організацію, де є:

- **Спільнота** — для взаємодопомоги, навчання, подій, підтримки ініціатив;
- **Ядро Ордену** — дисциплінована команда, що здатна організовано діяти, вести місії, координувати ресурси, підтримувати членів;
- **Порядок** — через внутрішні правила та Суд Честі, який допомагає вирішувати спірні ситуації, захищати репутацію та зберігати братерство.

Орден Ветеранів не є політичною партією. Ми — громадська структура, яка працює з конкретними потребами і конкретними діями: захист прав, підтримка, адаптація, розвиток та громадянські ініціативи. Ми віримо, що сильна країна тримається на сильних спільнотах. А сильні спільноти тримаються на довірі, дисципліні та повазі до честі людини.

<CTA
  title="Приєднуйтесь до Ордену"
  description="Станьте частиною спільноти, яка діє"
  buttonText="ПРИЄДНАТИСЯ"
  href="/join"
/>`,
    status: 'published',
    show_in_nav: true,
    nav_label: 'Про нас',
    sort_order: 1,
  },
  {
    slug: 'directions',
    title: 'НАПРЯМКИ',
    label: 'НАПРЯМКИ РОБОТИ',
    description: 'Шість ключових напрямків роботи Ордену Ветеранів.',
    content: `## Наші напрямки

Орден Ветеранів працює за шістьма ключовими напрямками, кожен з яких спрямований на конкретні потреби ветеранів та їхніх родин.

<CardGrid cols={3}>
<Card title="Адаптація">
Допомога у переході до цивільного життя, соціальна інтеграція, підтримка на всіх етапах.
</Card>
<Card title="Правовий захист">
Юридична допомога, захист прав ветеранів, консультації та супровід справ.
</Card>
<Card title="Психологічна підтримка">
Ментальне здоров'я, групи підтримки, професійна допомога спеціалістів.
</Card>
<Card title="Освіта та наставництво">
Навчання, менторство, розвиток навичок для нової кар'єри.
</Card>
<Card title="Громадянські кампанії">
Активізм, advocacy, вплив на державну політику щодо ветеранів.
</Card>
<Card title="Взаємодопомога">
Матеріальна підтримка, допомога у складних ситуаціях, братерська мережа.
</Card>
</CardGrid>

<CTA
  title="Приєднуйтесь до нас"
  description="Долучіться до спільноти, яка діє за кожним напрямком"
  buttonText="ПРИЄДНАТИСЯ"
  href="/join"
/>`,
    status: 'published',
    show_in_nav: true,
    nav_label: 'Напрямки',
    sort_order: 3,
  },
  {
    slug: 'mission',
    title: 'МІСІЯ',
    label: 'НАША МІСІЯ',
    description: 'Місія та цінності Ордену Ветеранів.',
    content: `## Наша місія

Об'єднувати ветеранів та їхніх союзників у структуровану спільноту, що діє на засадах честі, взаємопідтримки та відповідальності.

## Наші цінності

<CardGrid cols={3}>
<Card title="Честь">
Ми діємо відкрито, чесно та відповідально. Наші рішення відповідають нашим принципам.
</Card>
<Card title="Братерство">
Ми підтримуємо один одного. Ніхто не залишається сам у складній ситуації.
</Card>
<Card title="Дисципліна">
Ми дотримуємось правил та зобов'язань. Порядок — основа ефективної дії.
</Card>
</CardGrid>

## Наші цілі

1. Створити мережу підтримки для ветеранів по всій Україні
2. Забезпечити доступ до правової, психологічної та соціальної допомоги
3. Розвивати лідерські якості та можливості для самореалізації
4. Впливати на державну політику щодо ветеранів
5. Будувати спільноту, яка змінює суспільство на краще`,
    status: 'published',
    show_in_nav: true,
    nav_label: 'Місія',
    sort_order: 2,
  },
  {
    slug: 'governance',
    title: 'СТРУКТУРА УПРАВЛІННЯ',
    label: 'КЕРІВНИЦТВО',
    description: 'Організаційна структура та органи управління Ордену Ветеранів.',
    content: `## Тріада управління

Орден Ветеранів побудований на принципі Тріади — трьох незалежних, але взаємопов'язаних органів влади.

<CardGrid cols={3}>
<Card title="Президент">
Виконавча влада. Відповідальність за повсякденну діяльність та зовнішнє представництво.
</Card>
<Card title="Рада Командирів">
Стратегічна влада. Визначає напрямки розвитку та приймає ключові рішення.
</Card>
<Card title="Суд Честі">
Етична влада. Захищає цінності організації та вирішує внутрішні спори.
</Card>
</CardGrid>

## Принцип балансу

Жоден з органів не має абсолютної влади. Це забезпечує:

- Захист від зловживань
- Прозорість рішень
- Відповідальність перед членами
- Стабільність організації

## Членство в управлінні

Всі керівні посади обираються членами організації на визначений термін з можливістю переобрання.`,
    status: 'published',
    show_in_nav: false,
    sort_order: 5,
  },
  {
    slug: 'faq',
    title: 'ЧАСТІ ПИТАННЯ',
    label: 'FAQ',
    description: 'Відповіді на найпоширеніші питання про Орден Ветеранів.',
    content: `## Загальні питання

<AccordionGroup>
<Accordion title="Хто може приєднатись до Ордену?">
До Ордену можуть приєднатись ветерани бойових дій, їхні родичі, а також цивільні, які поділяють наші цінності та готові підтримувати спільноту.
</Accordion>
<Accordion title="Чи є членство платним?">
Базове членство безкоштовне. Існують добровільні внески для підтримки проєктів та діяльності організації.
</Accordion>
<Accordion title="Як стати членом?">
Заповніть заявку на сайті, пройдіть верифікацію та ознайомтесь з Кодексом Честі. Після схвалення ви отримаєте доступ до спільноти.
</Accordion>
</AccordionGroup>

<Divider />

## Діяльність

<AccordionGroup>
<Accordion title="Які програми підтримки існують?">
Ми маємо програми юридичної допомоги, психологічної підтримки, освітні курси, менторство та допомогу в працевлаштуванні.
</Accordion>
<Accordion title="Чи можна долучитись як волонтер?">
Так, ми завжди раді волонтерам. Зареєструйтесь та позначте, що хочете волонтерити — ми зв'яжемось з вами.
</Accordion>
</AccordionGroup>

<CTA
  title="Не знайшли відповідь?"
  description="Зв'яжіться з нами напряму"
  buttonText="КОНТАКТИ"
  href="/contacts"
/>`,
    status: 'published',
    show_in_nav: true,
    nav_label: 'FAQ',
    sort_order: 10,
  },
  {
    slug: 'code-of-honor',
    title: 'КОДЕКС ЧЕСТІ',
    label: 'КОДЕКС',
    description: 'Етичний кодекс та правила поведінки членів Ордену Ветеранів.',
    content: `## Основні принципи

Кожен член Ордену зобов'язується дотримуватись цих принципів:

<Steps>
<Step title="Честь понад усе">
Дій чесно, відкрито та відповідально. Твоє слово — твоя гарантія.
</Step>
<Step title="Братерство">
Підтримуй побратимів. Не залишай нікого в біді. Ділись ресурсами та знаннями.
</Step>
<Step title="Дисципліна">
Дотримуйся правил та зобов'язань. Виконуй взяті на себе обіцянки.
</Step>
<Step title="Відповідальність">
Відповідай за свої дії та рішення. Визнавай помилки та виправляй їх.
</Step>
<Step title="Розвиток">
Постійно вчись та вдосконалюйся. Допомагай розвиватись іншим.
</Step>
</Steps>

## Суд Честі

<Callout type="info" title="Механізм захисту">
Суд Честі — орган, що розглядає порушення Кодексу та спори між членами. Він забезпечує справедливе вирішення конфліктів та захист репутації організації.
</Callout>

Порушення Кодексу Честі може призвести до попередження, тимчасового обмеження прав або виключення з організації.`,
    status: 'published',
    show_in_nav: false,
    sort_order: 6,
  },
  {
    slug: 'manifest',
    title: 'МАНІФЕСТ',
    label: 'МАНІФЕСТ',
    description: 'Маніфест Ордену Ветеранів — наше бачення та заклик до дії.',
    content: `<Quote author="Орден Ветеранів">
Ми — ті, хто пройшов крізь вогонь і повернувся. Ми — ті, хто не здався і не зрадив. Ми — ті, хто будує майбутнє, не забуваючи минулого.
</Quote>

## Наше бачення

Ми бачимо Україну, де ветерани — не жертви обставин, а лідери змін. Де досвід війни стає силою для мирного будівництва. Де братерство на полі бою продовжується в мирному житті.

## Наш заклик

Ми закликаємо всіх, хто пройшов випробування війною:

- Не замикатись у собі
- Шукати підтримку та підтримувати інших
- Перетворювати біль на силу
- Будувати спільноту, що змінює країну

## Наша обіцянка

Ми обіцяємо:

- Бути поруч у найважчі моменти
- Захищати честь кожного члена
- Діяти прозоро та відповідально
- Будувати організацію, гідну нашої жертви

<CTA
  title="Приєднуйтесь до нас"
  description="Станьте частиною руху, що змінює Україну"
  buttonText="ПРИЄДНАТИСЯ"
  href="/join"
/>`,
    status: 'published',
    show_in_nav: false,
    sort_order: 7,
  },
  {
    slug: 'contacts',
    title: 'КОНТАКТИ',
    label: 'ЗВ\'ЯЗОК',
    description: 'Контактна інформація та способи зв\'язку з Орденом Ветеранів.',
    content: `## Зв'яжіться з нами

Ми завжди раді вашим запитанням та пропозиціям.

### Загальні запити

- **Email:** info@veterans-orden.org
- **Телефон:** +38 (044) 123-45-67

### Для ЗМІ

- **Email:** press@veterans-orden.org

### Юридичні питання

- **Email:** legal@veterans-orden.org

### Соціальні мережі

Слідкуйте за нами:
- Facebook
- Instagram
- Telegram

<CTA
  title="Готові приєднатися?"
  description="Зареєструйтесь і станьте частиною спільноти"
  buttonText="РЕЄСТРАЦІЯ"
  href="/join"
/>`,
    status: 'published',
    show_in_nav: true,
    nav_label: 'Контакти',
    sort_order: 20,
  },
  {
    slug: 'privacy',
    title: 'ПОЛІТИКА КОНФІДЕНЦІЙНОСТІ',
    label: 'ПРАВОВА ІНФОРМАЦІЯ',
    description: 'Політика конфіденційності та захисту персональних даних.',
    content: `## Збір даних

Ми збираємо лише ті дані, які необхідні для надання сервісів:

- Особисті дані при реєстрації (ім'я, email)
- Дані про використання сайту (cookies, аналітика)
- Інформацію, яку ви надаєте добровільно

## Використання даних

Ваші дані використовуються для:

- Надання доступу до функцій сайту
- Комунікації з вами
- Покращення наших сервісів
- Виконання юридичних зобов'язань

## Захист даних

Ми застосовуємо сучасні методи захисту:

- Шифрування передачі даних (HTTPS)
- Безпечне зберігання паролів
- Обмежений доступ до персональних даних

## Ваші права

Ви маєте право:

- Отримати копію своїх даних
- Вимагати виправлення або видалення
- Відмовитися від маркетингових повідомлень

<Callout type="info" title="Контакт">
З питань конфіденційності звертайтесь: privacy@veterans-orden.org
</Callout>

*Останнє оновлення: грудень 2024*`,
    status: 'published',
    show_in_nav: false,
    sort_order: 101,
  },
  {
    slug: 'documents',
    title: 'ДОКУМЕНТИ',
    label: 'ОФІЦІЙНІ ДОКУМЕНТИ',
    description: 'Офіційні документи організації для завантаження.',
    content: `## Офіційні документи

Нижче ви знайдете офіційні документи ГО "Орден Ветеранів" для ознайомлення та завантаження.

<Callout type="info" title="Примітка">
Документи регулярно оновлюються. Перевіряйте дату останньої редакції.
</Callout>

### Установчі документи

- Статут організації
- Рішення про реєстрацію

### Внутрішні документи

- Кодекс Честі
- Положення про Суд Честі
- Положення про членство

### Звітність

- Річний звіт 2024
- Фінансова звітність

*Для отримання документів зверніться до адміністрації.*`,
    status: 'published',
    show_in_nav: true,
    nav_label: 'Документи',
    sort_order: 15,
  },
  {
    slug: 'terms',
    title: 'УМОВИ ВИКОРИСТАННЯ',
    label: 'ПРАВОВА ІНФОРМАЦІЯ',
    description: 'Умови використання сайту та сервісів Ордену Ветеранів.',
    content: `## Загальні положення

Ці Умови використання регулюють відносини між ГО "Орден Ветеранів" та користувачами сайту veterans-orden.org.

## Права та обов'язки

Використовуючи наш сайт, ви погоджуєтесь:

- Надавати правдиву інформацію при реєстрації
- Не порушувати права інших користувачів
- Не використовувати сервіси для незаконних цілей
- Дотримуватися Кодексу Честі (для членів організації)

## Контент та інтелектуальна власність

Всі матеріали на сайті є власністю ГО "Орден Ветеранів" або використовуються за ліцензією. Копіювання без дозволу заборонено.

## Зміни в умовах

Ми залишаємо за собою право змінювати ці умови. Про суттєві зміни ми повідомимо користувачів.

*Останнє оновлення: грудень 2024*`,
    status: 'published',
    show_in_nav: false,
    sort_order: 100,
  },
  {
    slug: 'copyright',
    title: 'АВТОРСЬКІ ПРАВА',
    label: 'ПРАВОВА ІНФОРМАЦІЯ',
    description: 'Інформація про авторські права та інтелектуальну власність.',
    content: `## Інтелектуальна власність

Всі права на контент сайту veterans-orden.org належать ГО "Орден Ветеранів", якщо не вказано інше.

## Використання матеріалів

При використанні наших матеріалів:

- Обов'язкове посилання на джерело
- Заборонено комерційне використання без дозволу
- Заборонено модифікація без згоди

## Товарні знаки

Логотип та назва "Орден Ветеранів" є зареєстрованими товарними знаками.

## Повідомлення про порушення

Якщо ви вважаєте, що ваші права порушені, зв'яжіться з нами: legal@veterans-orden.org

© 2024 ГО "Орден Ветеранів". Всі права захищені.`,
    status: 'published',
    show_in_nav: false,
    sort_order: 102,
  },
];

/**
 * POST /api/admin/pages/reseed
 * Reseed all pages with correct MDX content
 * WARNING: This will overwrite existing page content!
 */
export async function POST(request: NextRequest) {
  const { user, profile, error } = await getAuthenticatedUserWithProfile(request);

  if (!user || error) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Only super_admin can reseed
  if (!profile || profile.role !== 'super_admin') {
    return NextResponse.json({ error: 'Forbidden - super_admin only' }, { status: 403 });
  }

  try {
    const supabase = await createClient();
    const results: { slug: string; status: 'success' | 'error'; message?: string }[] = [];

    for (const page of pagesToReseed) {
      const { error: upsertError } = await supabase.from('pages').upsert({
        title: page.title,
        slug: page.slug,
        label: page.label || null,
        description: page.description || null,
        content: page.content,
        status: page.status,
        show_in_nav: page.show_in_nav,
        nav_label: page.nav_label || null,
        sort_order: page.sort_order,
        published_at: page.status === 'published' ? new Date().toISOString() : null,
        updated_at: new Date().toISOString(),
      }, { onConflict: 'slug' });

      if (upsertError) {
        results.push({ slug: page.slug, status: 'error', message: upsertError.message });
      } else {
        results.push({ slug: page.slug, status: 'success' });
      }
    }

    const successful = results.filter(r => r.status === 'success').length;
    const failed = results.filter(r => r.status === 'error').length;

    return NextResponse.json({
      message: `Reseeded ${successful} pages, ${failed} failed`,
      results,
    });
  } catch (error) {
    console.error('[Pages Reseed] Error:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal server error' },
      { status: 500 }
    );
  }
}
